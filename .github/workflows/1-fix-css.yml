name: Step 1 - Fix CSS

on:
  push:
    branches-ignore:
      - main
    paths:
      - 'index.html'
  workflow_dispatch:

permissions:
  contents: read
  actions: write
  issues: write

jobs:
  find_exercise:
    name: Find Exercise Issue
    runs-on: ubuntu-latest
    outputs:
      issue-number: ${{ steps.find-issue.outputs.issue_number }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Find exercise issue
        id: find-issue
        run: |
          issue_number=$(gh issue list --search "GitHub MCP Workflow Exercise in:title" --state open --json number --jq '.[0].number')
          if [ -z "$issue_number" ]; then
            echo "No exercise issue found"
            exit 1
          fi
          echo "issue_number=$issue_number" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  check_step_work:
    name: Check CSS Fix
    runs-on: ubuntu-latest
    needs: [find_exercise]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Find last comment
        id: find-comment
        run: |
          comment_id=$(gh api \
            "/repos/${{ github.repository }}/issues/${{ needs.find_exercise.outputs.issue-number }}/comments" \
            --jq '.[-1].id')
          echo "comment_id=$comment_id" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update comment - checking work
        run: |
          gh api \
            --method PATCH \
            "/repos/${{ github.repository }}/issues/comments/${{ steps.find-comment.outputs.comment_id }}" \
            -f body="â³ **Checking your work...**"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate CSS link fix
        id: validate
        run: |
          if grep -q 'href="styles.css"' index.html; then
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "âœ… CSS link is correct!"
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "âŒ CSS link still has typo"
          fi

      - name: Update comment - results
        run: |
          if [ "${{ steps.validate.outputs.valid }}" == "true" ]; then
            result="âœ… Passed"
          else
            result="âŒ Failed"
          fi
          
          body="## Step 1 Results

          | Check | Status |
          |-------|--------|
          | CSS link corrected to \\\`styles.css\\\` | $result |"
          
          gh api \
            --method PATCH \
            "/repos/${{ github.repository }}/issues/comments/${{ steps.find-comment.outputs.comment_id }}" \
            -f body="$body"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Fail job if check failed
        if: steps.validate.outputs.valid != 'true'
        run: |
          gh issue comment ${{ needs.find_exercise.outputs.issue-number }} \
            --body-file responses/01-error-css-not-fixed.md
          exit 1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  post_next_step:
    name: Post Next Step
    needs: [find_exercise, check_step_work]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get response templates
        uses: actions/checkout@v4
        with:
          repository: skills/exercise-toolkit
          path: exercise-toolkit
          ref: v0.7.3

      - name: Create comment - step finished
        uses: GrantBirki/comment@v2.1.1
        with:
          issue-number: ${{ needs.find_exercise.outputs.issue-number }}
          body: |
            ## âœ… Step 1 Complete!

            Great job! You've successfully fixed the CSS link. Let's move on to the next step...

      - name: Create comment - add step content
        uses: GrantBirki/comment@v2.1.1
        with:
          issue-number: ${{ needs.find_exercise.outputs.issue-number }}
          file: responses/02-create-pr.md

      - name: Create comment - watching for progress
        uses: GrantBirki/comment@v2.1.1
        with:
          issue-number: ${{ needs.find_exercise.outputs.issue-number }}
          body: "ðŸ‘€ I'm watching for your Pull Request. When you create it, I'll check your work!"

      - name: Disable current and enable next workflow
        run: |
          gh workflow disable 1-fix-css.yml
          gh workflow enable 2-check-pr.yml
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Switch to main branch
        run: git checkout main

      - name: Build README from template
        id: build-readme
        uses: skills/action-text-variables@v3
        with:
          template-file: .github/readme-templates/step-2.md

      - name: Update README file
        run: echo "$README_CONTENT" > README.md
        env:
          README_CONTENT: ${{ steps.build-readme.outputs.updated-text }}

      - name: Commit README changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update README for step 2"
            git push
          fi
