name: Step 0 - Start Exercise

on:
  push:
    branches:
      - main
      - workflow-test
  workflow_dispatch:

permissions:
  contents: write
  actions: write
  issues: write

jobs:
  start_exercise:
    name: Start GitHub MCP Exercise
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check if exercise issue exists
        id: check-issue
        run: |
          issue_number=$(gh issue list --search "GitHub MCP Workflow Exercise in:title" --state open --json number --jq '.[0].number')
          if [ -z "$issue_number" ]; then
            echo "exists=false" >> $GITHUB_OUTPUT
          else
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "issue_number=$issue_number" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create exercise issue
        if: steps.check-issue.outputs.exists == 'false'
        id: create-issue
        run: |
          issue_url=$(gh issue create \
            --title "ðŸŽ“ GitHub MCP Workflow Exercise" \
            --body-file responses/00-welcome.md)
          issue_number=$(echo $issue_url | grep -o '[0-9]*$')
          echo "issue_number=$issue_number" >> $GITHUB_OUTPUT
          echo "Created issue #$issue_number"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set issue number
        id: set-issue
        run: |
          if [ "${{ steps.check-issue.outputs.exists }}" == "true" ]; then
            echo "issue_number=${{ steps.check-issue.outputs.issue_number }}" >> $GITHUB_OUTPUT
          else
            echo "issue_number=${{ steps.create-issue.outputs.issue_number }}" >> $GITHUB_OUTPUT
          fi

      - name: Post Step 1 instructions
        run: |
          gh issue comment ${{ steps.set-issue.outputs.issue_number }} \
            --body-file responses/01-fix-css.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post watching message
        run: |
          gh issue comment ${{ steps.set-issue.outputs.issue_number }} \
            --body "ðŸ‘€ I'm watching for your changes. When you push your CSS fix to a branch, I'll automatically check your work!"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable Step 1 workflow
        run: |
          gh workflow enable 1-fix-css.yml
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
