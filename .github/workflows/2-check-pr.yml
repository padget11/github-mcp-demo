name: Step 2 - Create PR

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  actions: write
  issues: write
  pull-requests: write

jobs:
  find_exercise:
    name: Find Exercise Issue
    runs-on: ubuntu-latest
    outputs:
      issue-number: ${{ steps.find-issue.outputs.issue_number }}
      
    steps:
      - name: Find exercise issue
        id: find-issue
        run: |
          issue_number=$(gh issue list --search "GitHub MCP Workflow Exercise in:title" --state open --json number --jq '.[0].number')
          if [ -z "$issue_number" ]; then
            echo "No exercise issue found"
            exit 1
          fi
          echo "issue_number=$issue_number" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  check_step_work:
    name: Check PR Creation
    runs-on: ubuntu-latest
    needs: [find_exercise]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Find last comment on issue
        id: find-comment
        run: |
          comment_id=$(gh api \
            "/repos/${{ github.repository }}/issues/${{ needs.find_exercise.outputs.issue-number }}/comments" \
            --jq '.[-1].id')
          echo "comment_id=$comment_id" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update comment - checking work
        run: |
          gh api \
            --method PATCH \
            "/repos/${{ github.repository }}/issues/comments/${{ steps.find-comment.outputs.comment_id }}" \
            -f body="‚è≥ **Checking your Pull Request...**"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check CSS fix in PR
        id: check-fix
        run: |
          if grep -q 'href="styles.css"' index.html; then
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "valid=false" >> $GITHUB_OUTPUT
          fi

      - name: Check PR description for issue link
        id: check-link
        run: |
          pr_body="${{ github.event.pull_request.body }}"
          if echo "$pr_body" | grep -qiE "(fixes|closes|resolves) #[0-9]+"; then
            echo "linked=true" >> $GITHUB_OUTPUT
          else
            echo "linked=false" >> $GITHUB_OUTPUT
          fi

      - name: Update comment - results
        run: |
          if [ "${{ steps.check-fix.outputs.valid }}" == "true" ]; then
            fix_result="‚úÖ Passed"
          else
            fix_result="‚ùå Failed"
          fi
          
          if [ "${{ steps.check-link.outputs.linked }}" == "true" ]; then
            link_result="‚úÖ Passed"
          else
            link_result="‚ö†Ô∏è  Missing"
          fi
          
          body="## Step 2 Results

          | Check | Status |
          |-------|--------|
          | CSS link is fixed | $fix_result |
          | PR links to issue with \\\`Fixes #\\\` | $link_result |"
          
          gh api \
            --method PATCH \
            "/repos/${{ github.repository }}/issues/comments/${{ steps.find-comment.outputs.comment_id }}" \
            -f body="$body"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on PR if needed
        if: steps.check-fix.outputs.valid != 'true' || steps.check-link.outputs.linked != 'true'
        run: |
          if [ "${{ steps.check-fix.outputs.valid }}" != "true" ]; then
            gh pr comment ${{ github.event.pull_request.number }} \
              --body "‚ùå The CSS link still appears to be broken. Make sure you changed \`href=\"styls.css\"\` to \`href=\"styles.css\"\`"
          elif [ "${{ steps.check-link.outputs.linked }}" != "true" ]; then
            gh pr comment ${{ github.event.pull_request.number }} \
              --body "‚ö†Ô∏è Your PR should link to the original issue using \`Fixes #<issue-number>\` or \`Closes #<issue-number>\` in the description!"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Fail job if checks failed
        if: steps.check-fix.outputs.valid != 'true' || steps.check-link.outputs.linked != 'true'
        run: exit 1

  post_completion:
    name: Complete Exercise
    needs: [find_exercise, check_step_work]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Comment - exercise complete
        run: |
          body="## üéâ Congratulations! Exercise Complete!

          You've successfully:
          - ‚úÖ Fixed the CSS bug
          - ‚úÖ Created a properly linked Pull Request
          - ‚úÖ Completed the GitHub MCP workflow!

          You can now merge your PR and close this issue. Great work! üöÄ"
          
          gh issue comment ${{ needs.find_exercise.outputs.issue-number }} \
            --body "$body"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add success comment to PR
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "üéâ **Excellent work!** Your PR looks perfect! You can now merge this to complete the exercise."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Disable workflow
        run: |
          gh workflow disable 2-check-pr.yml
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
